name: Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const releaseLabel = labels.find(l => l.startsWith('release:'));
            if (!releaseLabel) {
              core.setFailed('No release label found on merged PR');
              return;
            }
            const bump = releaseLabel.replace('release:', '');
            core.setOutput('type', bump);
            core.info(`Bump type: ${bump}`);

      - name: Get latest tag and compute next version
        id: version
        run: |
          LATEST=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"

          # Strip leading 'v'
          VERSION="${LATEST#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          BUMP="${{ steps.bump.outputs.type }}"
          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEXT="v${MAJOR}.${MINOR}.${PATCH}"
          echo "next=$NEXT" >> "$GITHUB_OUTPUT"
          echo "Previous: $LATEST â†’ Next: $NEXT"

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NOTES_FLAG=""
          if [ "${{ steps.version.outputs.latest }}" != "v0.0.0" ]; then
            NOTES_FLAG="--notes-start-tag ${{ steps.version.outputs.latest }}"
          fi
          gh release create "${{ steps.version.outputs.next }}" \
            --target main \
            --title "${{ steps.version.outputs.next }}" \
            --generate-notes \
            $NOTES_FLAG
