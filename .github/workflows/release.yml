name: Release

on:
  pull_request:
    types: [closed]
    branches: [main]

env:
  REGISTRY: ghcr.io
  OPERATOR_IMAGE: ghcr.io/${{ github.repository_owner }}/agent-operator
  RUNNER_IMAGE: ghcr.io/${{ github.repository_owner }}/agent-runner
  OPENCODE_RUNNER_IMAGE: ghcr.io/${{ github.repository_owner }}/agent-runner-opencode

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.next }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: bump
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const releaseLabel = labels.find(l => l.startsWith('release:'));
            if (!releaseLabel) {
              core.setFailed('No release label found on merged PR');
              return;
            }
            const bump = releaseLabel.replace('release:', '');
            core.setOutput('type', bump);
            core.info(`Bump type: ${bump}`);

      - name: Get latest tag and compute next version
        id: version
        run: |
          LATEST=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"

          # Strip leading 'v'
          VERSION="${LATEST#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          BUMP="${{ steps.bump.outputs.type }}"
          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEXT="v${MAJOR}.${MINOR}.${PATCH}"
          echo "next=$NEXT" >> "$GITHUB_OUTPUT"
          echo "Previous: $LATEST â†’ Next: $NEXT"

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NOTES_FLAG=""
          if [ "${{ steps.version.outputs.latest }}" != "v0.0.0" ]; then
            NOTES_FLAG="--notes-start-tag ${{ steps.version.outputs.latest }}"
          fi
          gh release create "${{ steps.version.outputs.next }}" \
            --target main \
            --title "${{ steps.version.outputs.next }}" \
            --generate-notes \
            $NOTES_FLAG

  build-operator:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ needs.release.outputs.version }}

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Compute tags
        id: tags
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          SEMVER="${VERSION#v}"
          MAJOR_MINOR="${SEMVER%.*}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAGS="${{ env.OPERATOR_IMAGE }}:${SEMVER}"
          TAGS="${TAGS},${{ env.OPERATOR_IMAGE }}:${MAJOR_MINOR}"
          TAGS="${TAGS},${{ env.OPERATOR_IMAGE }}:sha-${SHORT_SHA}"
          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"

      - name: Build and push operator
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-agent-runner:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ needs.release.outputs.version }}

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Compute tags
        id: tags
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          SEMVER="${VERSION#v}"
          MAJOR_MINOR="${SEMVER%.*}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAGS="${{ env.RUNNER_IMAGE }}:${SEMVER}"
          TAGS="${TAGS},${{ env.RUNNER_IMAGE }}:${MAJOR_MINOR}"
          TAGS="${TAGS},${{ env.RUNNER_IMAGE }}:sha-${SHORT_SHA}"
          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"

      - name: Build and push agent-runner
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: ./agent-runner
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-agent-runner-opencode:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ needs.release.outputs.version }}

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Compute tags
        id: tags
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          SEMVER="${VERSION#v}"
          MAJOR_MINOR="${SEMVER%.*}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAGS="${{ env.OPENCODE_RUNNER_IMAGE }}:${SEMVER}"
          TAGS="${TAGS},${{ env.OPENCODE_RUNNER_IMAGE }}:${MAJOR_MINOR}"
          TAGS="${TAGS},${{ env.OPENCODE_RUNNER_IMAGE }}:sha-${SHORT_SHA}"
          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"

      - name: Build and push agent-runner-opencode
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: ./agent-runner-opencode
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
